\section{Operations Initiated by Pedelec Station}

\subsection{Boot Notification}

\marginlabel{Description:}
After start-up of a \acs{PS}, the \acs{PS} sends a notification to the \acs{CMS} with information about its configuration (e.g., manufacturer id, connected station slots and pedelecs). \acs{CMS} will accept only registered stations. 

After each reboot, the Boot Notification is sent.

The \acs{CMS} sends a response with the acceptable status, including current time and heartbeat interval if accepted.

The \acs{PS} repeats the Boot Notification (in an appropriated interval) until the \acs{CMS} accepts the \acs{PS}. The \acs{PS} requests nothing else, until \acs{CMS} accepts it.


\marginlabel{URL:} \url{[BASE_CMS_URI]/boot}

\marginlabel{Method:} POST

\marginlabel{Request:}
\begin{table}[!h]
\vspace{-7mm}
\begin{tabularx}{\linewidth}{ | l | X | }
  \hline
  \textit{Field} & \textit{Description} \\
  \hline \hline
  stationManufacturerId 		& This value identifies the \acs{PS} by its hardware serial \\
  firmwareVersion			& Firmware version of \acs{PS}\\
  slots/slotManufacturerId 	& This value identifies the slot by its hardware serial \\
  slots/slotPosition			& The sequence position of the connected slot \\
  slots/pedelecManufacturerId & This value identifies the locked pedelec by its hardware serial related to the slot \\
    \hline
\end{tabularx}
\end{table}

\marginlabel{Response:}
\textbf{202 Accepted}

\begin{tabularx}{\linewidth}{ | l | X | }
  \hline
  \textit{Field} & \textit{Description} \\
  \hline \hline
  timestamp & Unix timestamp (seconds since epoch) \\
  heartbeatInterval & In seconds \\
    \hline
\end{tabularx}

\marginlabel{Errors:} 
\textbf{406 Not Acceptable} (If the station is not registered)

\textbf{5xx Server Error}

\subsection{Station Status Notification}

\marginlabel{Description:}
A \acs{PS} sends a notification to the \acs{CMS} to inform the \acs{CMS} about its status or error condition within the \acs{PS} including the connected station slots. A \acs{PS} shall send a Station Status Notification when it becomes unavailable as a result of an error condition or other external events.

\marginlabel{URL:} \url{[BASE_CMS_URI]/status/station}

\marginlabel{Method:} POST

\newpage
\marginlabel{Request:}
\begin{table}[!h]
\vspace{-7mm}
\begin{tabularx}{\linewidth}{ | l | X | }
  \hline
  \textit{Field} & \textit{Description} \\
  \hline \hline
  stationManufacturerId 		& This value identifies the \acs{PS} by its hardware serial\\
  stationErrorCode & \\
  stationInfo & \\
  stationState & See Section \ref{types:OperationState} \\
  timestamp & Unix timestamp (seconds since epoch) \\
  slots/slotManufacturerId 	& This value identifies the slot by its hardware serial \\
  slots/slotErrorCode & \\
  slots/slotInfo & \\
  slots/slotState & See Section \ref{types:OperationState} \\
  \hline
\end{tabularx}
\end{table}

\marginlabel{Response:} \textbf{200 OK}

\marginlabel{Errors:} \textbf{5xx Server Error}

\subsection{Pedelec Status Notification}

\marginlabel{Description:}
A \acs{PS} sends a notification to the \acs{CMS} to inform the \acs{CMS} about the status or error condition of connected pedelecs. A \acs{PS} shall send an Pedelec Status Notification when a pedelec becomes unavailable as a result of an error condition or other external events.

\marginlabel{URL:} \url{[BASE_CMS_URI]/status/pedelec}

\marginlabel{Method:} POST

\marginlabel{Request:}
\begin{table}[!h]
\vspace{-7mm}
\begin{tabularx}{\linewidth}{ | l | X | }
  \hline
  \textit{Field} & \textit{Description} \\
  \hline \hline
  pedelecManufacturerId 		& This value identifies the Pedelec by its hardware serial\\
  pedelecErrorCode & \\
  pedelecInfo & \\
  pedelecState & See Section \ref{types:OperationState} \\
  timestamp & Unix timestamp (seconds since epoch) \\
  \hline
\end{tabularx}
\end{table}

\marginlabel{Response:} \textbf{200 OK}

\marginlabel{Errors:} \textbf{5xx Server Error}


\subsection{Charging Status Notification}
\label{ps:charging-status}

\marginlabel{Description:}
The \acs{PS} informs the \acs{CMS} at regular intervals about the charging status (in time intervals or when fully charged) of all connected pedelecs of the \acs{PS}.

The message contains the current timestamp, the meter value (Wh), the charging state (e.g., charging, completed), the PedelecID and StationSlotID.

\marginlabel{URL:} \url{[BASE_CMS_URI]/status/charging}

\marginlabel{Method:} POST

\newpage
\marginlabel{Request:}
\begin{table}[!h]
\vspace{-7mm}
\begin{tabularx}{\linewidth}{ | l | X | }
  \hline
  \textit{Field} & \textit{Description} \\
  \hline \hline
  	pedelecManufacturerId			& \\
  	slotManufacturerId					& \\
  	meterValue & \\
  	batteryLevel & integer charge percentage \\
  	maxBatteryRange & ideal riding range in meters \\
  	chargingState			& \\
 	timestamp			& Unix timestamp (seconds since epoch) \\
  	
    \hline
\end{tabularx}
\end{table}

\marginlabel{Response:} \textbf{200 OK}

\marginlabel{Errors:} \textbf{5xx Server Error}

\subsection{Authorize}

\marginlabel{Description:}
Before a user can choose and unlock a pedelec with his CustomerCard (e.g., Bluecard), the \acs{PS} needs to be able to authorize the operation. Only after authorization the \acs{PS} will be able to unlock the pedelec. For this purpose the \acs{PS} needs user's Card-ID and PIN for authorization.

The response shall indicate, whether or not the Card-ID and PIN combination is accepted by the \acs{CMS}.

\marginlabel{URL:} \url{[BASE_CMS_URI]/authorize}

\marginlabel{Method:} POST

\marginlabel{Request:}
\begin{table}[!h]
\vspace{-7mm}
\begin{tabularx}{\linewidth}{ | l | X | }
  \hline
  \textit{Field} & \textit{Description} \\
  \hline \hline
  	cardId 		& Card specific number\\
  	pin			& User's secret PIN \\
    \hline
\end{tabularx}
\end{table}

\marginlabel{Response:}
\textbf{202 Accepted} (If credentials are accepted)

\begin{tabularx}{\linewidth}{ | l | X | }
  \hline
  \textit{Field} & \textit{Description} \\
  \hline \hline
  userId						& User related to CardId \\
    \hline
\end{tabularx}

\marginlabel{Errors:} \textbf{406 Not Acceptable}

\textbf{5xx Server Error}

\subsection{Start Transaction}

\marginlabel{Description:}
When the rental is authenticated, the station slot is unlocked and the user took the pedelec out of the slot, the \acs{PS} needs to inform the \acs{CMS} about this.

As response the \acs{CMS} sends an acknowledgment.

\marginlabel{URL:} \url{[BASE_CMS_URI]/transaction/start}

\marginlabel{Method:} POST

\newpage
\marginlabel{Request:} 
\begin{table}[!h]
\vspace{-7mm}
\begin{tabularx}{\linewidth}{ | l | X | }
  \hline
  \textit{Field} & \textit{Description} \\
  \hline \hline
  	userId 		& \\
  	pedelecManufacturerId			& \\
  	stationManufacturerId			& \\
  	slotManufacturerId			& \\
  	timestamp					& Unix timestamp (seconds since epoch) \\
    \hline
\end{tabularx}
\end{table}

\marginlabel{Response:} \textbf{200 OK}

\marginlabel{Errors:} \textbf{5xx Server Error}

\subsection{Stop Transaction}

\marginlabel{Description:}
After the \acs{PS} recognizes the return of a pedelec at a station slot, it needs to inform the \acs{CMS} about this.

As response the \acs{CMS} sends an acknowledgment.

\marginlabel{URL:} \url{[BASE_CMS_URI]/transaction/stop}

\marginlabel{Method:} POST

\marginlabel{Request:} 
\begin{table}[!h]
\vspace{-7mm}
\begin{tabularx}{\linewidth}{ | l | X | }
  \hline
  \textit{Field} & \textit{Description} \\
  \hline \hline
  	pedelecManufacturerId			& \\
  	stationManufacturerId			& \\
  	slotManufacturerId			& \\
  	timestamp					& Unix timestamp (seconds since epoch) \\
  	
    \hline
\end{tabularx}
\end{table}

\marginlabel{Response:} \textbf{200 OK}

\marginlabel{Errors:} \textbf{5xx Server Error}

\subsection{Heartbeat}

\marginlabel{Description:}
To let the \acs{CMS} know that a station is still connected, a \acs{PS} sends heartbeats regularly in configurable time intervals.

The \acs{CMS} sends a response with the current time of the \acs{CMS}, which could be used to synchronize the time of the \acs{PS} with the time of the \acs{CMS}.

\marginlabel{URL:} \url{[BASE_CMS_URI]/heartbeat}

\marginlabel{Method:} GET

\marginlabel{Request:} -

\marginlabel{Response:} \textbf{200 OK}

\begin{tabularx}{\linewidth}{ | l | X | }
  \hline
  \textit{Field} & \textit{Description} \\
  \hline \hline
  	timestamp			& Unix timestamp (seconds since epoch) \\	
  \hline
\end{tabularx}


\marginlabel{Errors:} \textbf{5xx Server Error}


\subsection{Firmware Status Notification}

\marginlabel{Description:}
A PS notifies CMS about the success/failure of the firmware update. 

\marginlabel{URL:} \url{[BASE_CMS_URI]/firmware-status}

\marginlabel{Method:} POST

\marginlabel{Request:} 
\begin{tabularx}{\linewidth}{ | l | X | }
  \hline
  \textit{Field} & \textit{Description} \\
  \hline \hline
  	status			& Progress status of the firmware update; see Section \ref{types:FirmwareState} \\	
  \hline
\end{tabularx}

\marginlabel{Response:} \textbf{200 OK}

\marginlabel{Errors:} \textbf{5xx Server Error}